name: Visual Test

on:
  workflow_run:
    workflows: ["Logic Test"]
    types:
      - completed
  workflow_dispatch:

jobs:
  run-and-analyze-color:
    if: ${{ (github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/master') || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Odin
      uses: laytan/setup-odin@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Compile Odin vendor library
      run: |
        make -C /home/runner/odin/vendor/stb/src
        make -C /home/runner/odin/vendor/cgltf/src

    - name: Setup Vulkan SDK
      uses: humbletim/install-vulkan-sdk@v1.2
      with:
        version: 1.4.321.1
        cache: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          libglfw3-dev \
          imagemagick \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          mesa-vulkan-drivers \
          vulkan-tools \
          x11-utils
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libglfw.so.3 /usr/lib/x86_64-linux-gnu/libglfw.so

    - name: Inspect Vulkan SDK assets
      run: |
        echo "Layers:" && find "$VULKAN_SDK" -maxdepth 4 -name 'VkLayer_screenshot.json' || true
        echo "Layer libraries:" && find "$VULKAN_SDK" -maxdepth 4 -name 'libVkLayer_screenshot.so' || true
        echo "ICDs:" && ls -1 /usr/share/vulkan/icd.d || true

    - name: Build shader
      run: make shader

    - name: Smoke test
      run: make build

    - name: Run visual scenes and capture screenshots
      env:
        VK_LAYER_PATH: ${{ env.VULKAN_SDK }}/etc/vulkan/explicit_layer.d:${{ env.VULKAN_SDK }}/share/vulkan/explicit_layer.d
        VK_ICD_FILENAMES: /usr/share/vulkan/icd.d/lvp_icd.x86_64.json
        # VK_LOADER_DEBUG: all
        RMSE_THRESHOLD: 100
      run: |
        export LD_LIBRARY_PATH="$VULKAN_SDK/lib:$VULKAN_SDK/lib64:${LD_LIBRARY_PATH:-}"
        tests=()
        while IFS= read -r -d '' path; do
          name=$(basename "$path")
          if [ "$name" = "common" ]; then
            continue
          fi
          tests+=("$name")
        done < <(find test/visual -mindepth 1 -maxdepth 1 -type d -print0 | sort -z)
        failures=()
        for test in "${tests[@]}"; do
          echo "Executing visual test: $test"
          if ! ./test/visual/run.sh "$test" artifacts; then
            echo "Test failed: $test" >&2
            failures+=("$test")
          fi
        done
        if [ ${#failures[@]} -ne 0 ]; then
          echo "Visual tests failed: ${failures[*]}" >&2
          exit 1
        fi
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: artifacts
        path: |
          artifacts
          game_output.log
