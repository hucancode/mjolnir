name: Visual Test

on:
  workflow_dispatch:

jobs:
  run-and-compare-images:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Odin
      uses: laytan/setup-odin@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Compile Odin vendor library
      run: |
        make -C /home/runner/odin/vendor/stb/src
        make -C /home/runner/odin/vendor/cgltf/src

    - name: Setup Vulkan SDK
      uses: humbletim/install-vulkan-sdk@v1.2
      with:
        version: 1.4.321.1
        cache: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          libglfw3-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          mesa-vulkan-drivers \
          vulkan-tools \
          x11-utils \
          gdb

        sudo ln -sf /usr/lib/x86_64-linux-gnu/libglfw.so.3 /usr/lib/x86_64-linux-gnu/libglfw.so
        echo "LAVAPIPE_ICD=/usr/share/vulkan/icd.d/lvp_icd.x86_64.json" >> $GITHUB_ENV

    - name: Install ImageMagick 7
      run: |
        sudo apt-get install -y build-essential wget pkg-config libpng-dev
        wget -q https://imagemagick.org/archive/ImageMagick.tar.gz
        tar xzf ImageMagick.tar.gz
        cd ImageMagick-7.*

        # Minimal static build with PNG and SSIM support
        ./configure --quiet --disable-shared

        make -j$(nproc)
        sudo make install
        sudo ldconfig /usr/local/lib

        # Verify installation
        magick --version | head -3

    - name: Inspect Vulkan SDK assets
      run: |
        echo "Layers:" && find "$VULKAN_SDK" -maxdepth 4 -name 'VkLayer_screenshot.json' || true
        echo "Layer libraries:" && find "$VULKAN_SDK" -maxdepth 4 -name 'libVkLayer_screenshot.so' || true
        echo "ICDs:" && ls -1 /usr/share/vulkan/icd.d || true

    - name: Build shader
      run: make shader

    - name: Query Vulkan device capabilities
      env:
        VK_ICD_FILENAMES: ${{ env.LAVAPIPE_ICD }}
      run: |
        export LD_LIBRARY_PATH="$VULKAN_SDK/lib:$VULKAN_SDK/lib64:${LD_LIBRARY_PATH:-}"
        echo "=== Vulkan Instance Info ==="
        vulkaninfo --summary || true
        echo ""
        echo "=== Available Devices ==="
        vulkaninfo | grep -A 20 "^GPU" || true
        echo ""
        echo "=== Device Features ==="
        vulkaninfo | grep -A 50 "VkPhysicalDeviceFeatures" || true
        echo ""
        echo "=== Device Limits ==="
        vulkaninfo | grep -A 30 "VkPhysicalDeviceLimits" || true

    - name: Run visual tests
      env:
        VK_LAYER_PATH: ${{ env.VULKAN_SDK }}/etc/vulkan/explicit_layer.d:${{ env.VULKAN_SDK }}/share/vulkan/explicit_layer.d
        VK_ICD_FILENAMES: ${{ env.LAVAPIPE_ICD }}
      run: |
        export LD_LIBRARY_PATH="$VULKAN_SDK/lib:$VULKAN_SDK/lib64:${LD_LIBRARY_PATH:-}"
        make vtest
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: artifacts
        path: |
          artifacts
          game_output.log
